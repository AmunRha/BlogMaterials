#define CALL_FIRST 1

void myHiddenFunction() {
    printf("[*] myHiddenFunction() Called\n");
    exit(0);
}


LONG WINAPI myHandler(
    struct _EXCEPTION_POINTERS* ExceptionInfo
) {
    if (ExceptionInfo->ExceptionRecord->ExceptionCode == STATUS_INTEGER_DIVIDE_BY_ZERO || ExceptionInfo->ExceptionRecord->ExceptionCode == STATUS_FLOAT_DIVIDE_BY_ZERO) {
        ULONG64 myHiddenFunction_Offset = 0x1000;
        HMODULE BaseAddress = GetModuleHandleA(NULL);
        printf("[*] Base Address of our process: %#llx\n", (ULONG64)BaseAddress);
        ULONG64 myHiddenFunctionAddress = (ULONG64)BaseAddress + myHiddenFunction_Offset;
        printf("[*] Address of myHiddenFunction: %#llx\n", (ULONG64)myHiddenFunctionAddress);
        ExceptionInfo->ContextRecord->Rip = (DWORD64)myHiddenFunctionAddress;
        printf("[*] RIP modified to address of myHiddenFunction: %#llx\n", ExceptionInfo->ContextRecord->Rip);
    }
    return EXCEPTION_CONTINUE_EXECUTION;
}

int main()
{
    PVOID h1 = AddVectoredExceptionHandler(CALL_FIRST, myHandler);
    int inp1 = 0, inp2 = 0;
    int result = inp1 / inp2;
    RemoveVectoredExceptionHandler(h1);
    return 0;
}
