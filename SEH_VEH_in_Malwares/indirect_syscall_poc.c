typedef NTSTATUS(NTAPI* pfnNtAllocateVirtualMemory) (
    IN HANDLE               ProcessHandle,
    IN OUT PVOID*           BaseAddress,
    IN ULONG                ZeroBits,
    IN OUT PULONG           RegionSize,
    IN ULONG                AllocationType,
    IN ULONG                Protect
    );

#define CALL_FIRST 1

ULONG_PTR  RetrieveSyscallAddr() {
    FARPROC fnDrawText = GetProcAddress(GetModuleHandleA("ntdll.dll"), "NtDrawText");
    BYTE* ptr_sysaddr = (BYTE*)(fnDrawText);
    BYTE sig_syscall[] = { 0x0f, 0x05, 0xc3 };
    int cnt_sig = 0, cnt_fn = 0;
    while (TRUE) {
        if (ptr_sysaddr[cnt_fn] == sig_syscall[cnt_sig]) {
            cnt_fn++;
            cnt_sig++;
            if (cnt_sig == sizeof(sig_syscall)) {
                ptr_sysaddr += cnt_fn - sizeof(sig_syscall);
                break;
            }
        }
        else {
            cnt_fn = cnt_fn - cnt_sig + 1;
            cnt_sig = 0;
        }
    }
    return (ULONG_PTR)ptr_sysaddr;
}

LONG WINAPI myHandler(
    struct _EXCEPTION_POINTERS* ExceptionInfo
) {
    if (ExceptionInfo->ExceptionRecord->ExceptionCode == STATUS_ACCESS_VIOLATION) {
        printf("[*] Exception Caught: STATUS_ACCESS_VIOLATION\n");
        ExceptionInfo->ContextRecord->R10 = ExceptionInfo->ContextRecord->Rcx;
        DWORD64 ssn = ExceptionInfo->ContextRecord->Rip;
        printf("[*] Syscall Number: %#x\n", (INT32)ssn);
        ExceptionInfo->ContextRecord->Rax = ssn;
        ULONG_PTR SyscallAddr = RetrieveSyscallAddr();
        ExceptionInfo->ContextRecord->Rip = SyscallAddr;
        return EXCEPTION_CONTINUE_EXECUTION;
    }
    return EXCEPTION_CONTINUE_SEARCH;
}

int main()
{
    PVOID h1 = AddVectoredExceptionHandler(CALL_FIRST, myHandler);
    pfnNtAllocateVirtualMemory NtAllocateVirtualMemory = (pfnNtAllocateVirtualMemory)0x18;
    PVOID retAddr = NULL;
    ULONG size = 0x1000;
    NtAllocateVirtualMemory(GetCurrentProcess(), &retAddr, NULL, (PULONG)&size, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
    if (retAddr == NULL) {
        printf("[!] NtAllocateVirtualMemory Failed\n");
    }
    else {
        printf("[*] NtAllocateVirtualMemory Success: %#llx\n", (ULONG64)retAddr);
    }
    RemoveVectoredExceptionHandler(h1);
    return 0;
}
